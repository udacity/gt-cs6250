NYTD.Video.Ad.Model.AdModel=function(){var e={player:null,playerType:null,positions:"",pagename:"",adxTrackingContainer:null,adxTrackingContainerId:null,requestVidPosition:0,requestFetched:!1,videoPlayerAd:"",bigAdContainer:null,bigAd:"",stageADXBaseURL:"www.stg.nytimes.com",productionADXBaseURL:"www.nytimes.com",adBaseURL:"",debugMode:"0",interstitialAllowed:0,bigAdRegExp:new RegExp("ADXINFO","i"),adModule:null,contentModule:null,videoModule:null,callback:"",imageRegExp:/image\/{1}(jpg|gif|jpeg|png)/,iframeWidth:"300",iframeHeight:"250",iframeBorder:"0",iframeScrolling:"no",iframeSrc:"#",iframeMarginWidth:"0",iframeMarginHeight:"0",iframeNoResize:"noresize",subscription:new NYTD.Subscription,adFrequency:2,bannerWidth:300,bannerHeight:250,maxVidPosition:2,adCountdown:null},t=NYTD.Video.Logger.get("AdsModel"),n=function(){window.location.host.indexOf("localhost")!==-1?e.adxBaseURL=e.stageADXBaseURL:window.location.host.indexOf("-int01.")!==-1?e.adxBaseURL=e.stageADXBaseURL:e.adxBaseURL=e.productionADXBaseURL,t.debug("setADXBaseURL",e.adxBaseURL)};return e.init=function(e){n(),t.debug("init")},e},function(){"use strict";return this.VASTModel=function(){this.proxyBaseUrl="http://www.nytimes.com/video/svc/ads/video/vast/index.html?",this.pageURL=window.location.href.toString(),this.playerWidth=0,this.playerHeight=0,this.videoTitle="",this.videoId=0,this.vastURL=null,this.callback=null,this.$=null,this.imageRegExp=/image\/.*/,this.bigAdContainer=null,this.init=function(){this.$=NYTD.Video.$,e.call(this)};var e=function(){if(NYTD&&NYTD.env){if(NYTD.env==="production")this.proxyBaseURL=[NYTD.Video.Ad.SERVER_PRODUCTION,"/video/svc/ads/video/vast/index.html?"].join("");else if(NYTD.env==="staging"||NYTD.env==="development")this.proxyBaseURL=[NYTD.Video.Ad.SERVER_STAGING,"/video/svc/ads/video/vast/index.html?"].join("")}else this.proxyBaseURL=[NYTD.Video.Ad.SERVER_PRODUCTION,"/video/svc/ads/video/vast/index.html?"].join("")};return this.init(),this},this}.call(NYTD.Video.Ad.Model),function(){"use strict";return this.AbstractAdController=Backbone.Model.extend({videoEvents:null,validation:null,model:null,vastController:null,logger:null,skipAd:!1,showVideoAdCountDown:!1,videoAdCountDownPlayerTypes:["library","homepage","article","article inline","blog","embed"],videoAdCountdownHTML:null,videoAdDuration:15,videoAdCountdown:null,videoAdSkipButton:null,skippableAdDuration:30,adDurationBeforeSkippable:null,skipAdCopy:["YOU CAN SKIP THIS AD IN ",15," SECONDS."],adCountdownCopy:["YOUR VIDEO WILL START IN ",15," SECONDS."],videoAdCountdownCSS:NYTD.Video.BaseURL+"/css/0.1/screen/common/modules/video/adCountdown.css",isVideoAdCountdownVisible:!1,ricocheCampaignSent:!1,documentHead:NYTD.Video.DOCUMENT_HEAD,initialize:function(e){this.logger=NYTD.Video.Logger.get("NYTD.Video.Ad.Controller.AbstractAdController"),this.videoEvents=NYTD.Video.VideoEvents},setup:function(e){if(NYTD.Video.Validation.isEmpty(e)||NYTD.Video.Validation.isEmpty(e.player))throw new Error("Missing one or more required parameters");this.setAdsModel(),this.model.position=e.positions,this.model.pagename=e.pagename,this.model.player=e.player,this.model.playerType=e.playerType,e.adxKeywords&&(this.model.keywords=e.adxKeywords),e.bannerWidth&&(this.model.bannerWidth=e.bannerWidth),e.bannerHeight&&(this.model.bannerHeight=e.bannerHeight),e.adFrequency&&(this.logger.debug("init::setting ad frequency",e.adFrequency),this.model.adFrequency=e.adFrequency);if(e.adCountdown==="true"||e.adCountdown===!0)this.model.adCountdown=!0;else if(e.adCountdown==="false"||e.adCountdown===!1)this.model.adCountdown=!1;this.logger.debug("init::setting ad countdown",this.model.adCountdown),typeof e.bigAdContainer=="string"?this.model.bigAdContainer=document.getElementById(e.bigAdContainer.replace("#","")):typeof e.bigAdContainer!="undefined"&&(this.model.bigAdContainer=e.bigAdContainer),this.model.player.defaultProps.adDurationBeforeSkippable&&(this.adDurationBeforeSkippable=this.model.player.defaultProps.adDurationBeforeSkippable),this.model.player.defaultProps.skippableAdDuration&&(this.skippableAdDuration=this.model.player.defaultProps.skippableAdDuration),this.setADXCallback(),this.setADXTrackingContainer(),this.registerListeners();if(NYTD.Video.$.inArray(this.model.playerType,this.videoAdCountDownPlayerTypes)!==-1&&this.model.adCountdown!==!1||this.model.adCountdown===!0)this.showVideoAdCountDown=!0,this.loadSupportCSS();this.logger.debug("Abstract Ad Controller, initialization complete")},setAdsModel:function(){this.model=new NYTD.Video.Ad.Model.AdModel,this.model.init()},setADXTrackingContainer:function(){this.model.adxTrackingContainer||(this.model.adxTrackingContainerId=NYTD.Video.Utils.generateCallbackName("adxTracking"),this.model.adxTrackingContainer=document.createElement("div"),this.model.adxTrackingContainer.setAttribute("id",this.model.adxTrackingContainerId),this.model.adxTrackingContainer.setAttribute("visibility","hidden"),NYTD.Video.$("body").append(NYTD.Video.$(this.model.adxTrackingContainer)),this.logger.debug("setADXTrackingContainer - Container ID: "+this.model.adxTrackingContainerId))},setADXCallback:function(){NYTD.Video.Validation.isEmpty(this.model.callback)&&(this.model.callback=NYTD.Video.Utils.generateCallbackName(this.model.player.getObjectId()+"_adx_video_success"))},setPageUrl:function(){typeof NYTD.env=="undefined"||NYTD.env&&NYTD.env!=="production"?this.model.pageUrl="http://video.nytimes.com":this.model.pageUrl=window.location.href.toString()},removeADXTrackingContainer:function(){NYTD.Video.Validation.isEmpty(this.model.adxTrackingContainer)||NYTD.Video.$(this.model.adxTrackingContainer).remove()},removeBigAd:function(){if(!NYTD.Video.Validation.isEmpty(this.model.bigAdContainer)){var e=this.model.bigAdContainer.children();if(e){var t=e.first();t&&t.remove()}}},getAdPosition:function(){return this.model.requestVidPosition},getRequestVidPosition:function(){return this.model.requestVidPosition<=0?this.model.requestVidPosition=1:this.model.requestVidPosition<this.model.maxVidPosition?this.model.requestVidPosition++:this.model.requestVidPosition=1,this.logger.debug("getRequestVidPosition - Current ad position is "+this.model.requestVidPosition),this.model.requestVidPosition},getTag:function(e,t){for(var n=0;n<e.length;n++){var r=e[n];if(t.test(r)){var i=r.indexOf("_")+1;return r.substring(i)}}return""},addToKeywords:function(e,t){if(t&&e&&e.push&&typeof t=="string"){var n=t.replace(/\&/g,"").replace(/\?/g,""),r=["%22",encodeURIComponent(n),"%22"].join("");NYTD.Video.$.inArray(r,e)===-1&&e.push(r)}return e},buildADXRequestURL:function(e){var t=this.getRequestVidPosition();if(t===!1)return this.resumeContent(),!1;var n="/vid"+t,r=NYTD.Video.Utils.getQueryParams();r&&r.pagename&&(this.model.pagename=r.pagename);var i="",s=null,o="",u="",a="",f="",l=this.model.position,c=[];if(typeof l=="string"&&l.length>0){var h=l.split(","),p=h.length;for(var d=0;d<p;d++){var v=encodeURIComponent(h[d].replace(/^\s+|\s+$/g,""));c.push(["%22",v,"%22"].join(""))}}l=c.join(","),this.model&&this.model.videoModule&&this.model.videoModule.getCurrentVideo&&(s=this.model.videoModule.getCurrentVideo()),s&&(s.customFields&&s.customFields.series&&(a=s.customFields.series),s.tags&&(o=this.getTag(s.tags,/nytsec0_(.+)/),u=this.getTag(s.tags,/nytsec1_(.+)/))),this.model&&this.model.playerType&&(f=this.model.playerType.toLowerCase().replace(/\s/g,"-").replace(/\|/g,"-")),this.model.player.type==="html5"&&NYTD.Video.$.browser.msie&&parseInt(NYTD.Video.$.browser.version,10)===9&&(this.model.pagename="video.nytimes.com/noads");if(this.model.pagename)i=this.model.pagename+n;else{i=["vid",t,".nytimes.com"],o&&(i.push("/"),i.push(o)),u&&(i.push("/"),i.push(u)),f&&(i.push("/"),i.push(f));if(a){var m=a.toLowerCase().replace(/\s/g,"-");i.push("/"),i.push(m)}i=i.join("")}var g=[],y="",b="",w=0;if(NYTD&&NYTD.jQuery){y=NYTD.jQuery("meta[name=keywords]");if(y){y=y.attr("content");if(y&&y.length&&y.length>0){var E=y.split(","),S=E.length;for(w=0;w<S;w++){var x=E[w].replace(/^\s+|\s+$/g,"");g=this.addToKeywords(g,x)}}}b=NYTD.jQuery("meta[name=author]");if(b){b=b.attr("content");if(b&&b.length&&b.length>0){var T=b.split(";"),N=T.length;for(w=0;w<N;w++){var C=T[w].replace(/^\s+|\s+$/g,"");g=this.addToKeywords(g,C)}}}}if(r&&r.keywords&&r.keywords!==""&&r.rico&&parseInt(r.rico,10)===1&&!this.ricocheCampaignSent){var k=r.keywords;k&&(g=["%22",encodeURIComponent(r.keywords),"%22"].join(""),this.ricocheCampaignSent=!0)}else g=this.addToKeywords(g,o),g=this.addToKeywords(g,u),g=this.addToKeywords(g,a),this.model.player.type==="html5"&&(g=this.addToKeywords(g,"HTML5"));var L=["[","{","%22videoads%22:{","%22url%22:%22",i,"%22,","%22positions%22:[",l,"],","%22keywords%22:[",g,"]","}","}","]"].join(""),A=["http://",this.model.adxBaseURL,"/svc/adxmulti?","&debug=",this.model.debugMode.toString(),"&interstitial_allowed=",this.model.interstitialAllowed,"&json_request=",L].join("");return this.logger.debug("buildADXRequestURL",A),A},dropADXClientSide:function(e){var t=null,n=/\s*(<img.+src=['"])(.+)$/gi,r=n.exec(e);r&&r.length==3&&(t=[r[1],"http://www.nytimes.com",r[2]].join(""),this.model.adxTrackingContainer.innerHTML=t,this.logger.debug("dropADXClientSide - ADX client side dropped: "+t))},isProduction:function(){return NYTD.env&&NYTD.env==="production"},getSubscription:function(){return this.model.subscription},buildVideoAdNotice:function(e){this.logger.debug("buildVideoAdNotice",e);if(this.showVideoAdCountDown){var t=NYTD.Video.$(document.createElement("div"));this.videoAdCountdown=NYTD.Video.$(document.createElement("p")),this.videoAdSkipButton=NYTD.Video.$(document.createElement("button")),this.adDurationBeforeSkippable===null&&(this.adDurationBeforeSkippable=Math.floor(e/2));var n="";e>=this.skippableAdDuration?(this.skipAdCopy[1]=this.adDurationBeforeSkippable,n=this.skipAdCopy):(this.adCountdownCopy[1]=e,n=this.adCountdownCopy),n[1]<10&&(n[1]=["0",n[1]].join("")),this.videoAdCountdown.html(n.join("")),this.videoAdSkipButton.html("SKIP AD"),t.addClass("videoAdCountdownContainer"),this.videoAdCountdown.addClass("videoAdCountdown"),this.videoAdSkipButton.addClass("videoAdSkipButton").hide(),t.append(this.videoAdCountdown),t.append(this.videoAdSkipButton),this.model.player.defaultProps.width<=337&&t.addClass("videoAdCountdownContainerSmall"),this.videoAdCountdownHTML=t}},addVideoAdCountdown:function(){this.logger.debug("addVideoAdCountdown");if(this.showVideoAdCountDown&&this.model&&this.model.player){var e=this.model.player.getContainer();e&&(NYTD.Video.$(e).prepend(this.videoAdCountdownHTML),this.isVideoAdCountdownVisible=!0)}},removeVideoAdCountdown:function(){this.logger.debug("removeVideoAdCountdown"),this.showVideoAdCountDown&&(this.videoAdSkipButton&&this.videoAdSkipButton.hide(),this.videoAdCountdownHTML&&typeof this.videoAdCountdownHTML.remove=="function"&&(this.videoAdCountdownHTML.remove(),this.isVideoAdCountdownVisible=!1))},showVideoSkipButton:function(){if(this.showVideoAdCountDown&&this.videoAdSkipButton&&!this.videoAdSkipButton.is(":visible")){this.logger.debug("showVideoSkipButton"),this.videoAdSkipButton.removeClass("hover").fadeIn("slow");var e=this;this.videoAdSkipButton.bind("click",function(t){e.logger.debug("clickVideoSkipButton"),e.model&&e.model.adModule&&typeof e.model.adModule.stopAd=="function"&&(e.removeVideoAdCountdown(),e.model.adModule.stopAd(),e&&e.model&&e.model.player&&e.model.player.subscription&&e.model.player.subscription.notify(NYTD.Video.VideoEvents.AD_SKIPPED,{}))}),this.videoAdSkipButton.hover(function(){NYTD.Video.$(this).addClass("hover")},function(){NYTD.Video.$(this).removeClass("hover")})}},loadSupportCSS:function(){NYTD.Video.$("head").append('<link rel="stylesheet" type="text/css" href="'+this.videoAdCountdownCSS+'">')}}),this}.call(NYTD.Video.Ad.Controller),function(){"use strict";this.FlashAdPrivateController=this.AbstractAdController.extend({logger:null,initialize:function(e){this.logger=NYTD.Video.Logger.get("NYTD.Video.Ad.Controller.FlashAdController"),this.videoEvents=NYTD.Video.VideoEvents,this.setup(e),this.setBCRoadSync(),this.logger.debug("initialization complete")},setADXCallback:function(){NYTD.Video.Validation.isEmpty(this.model.callback)&&(this.model.callback=NYTD.Video.Utils.generateCallbackName(this.model.player.getObjectId()+"__adx_video_success"))},destroy:function(){},setAdsModel:function(){this.model=new NYTD.Video.Ad.Model.AdModel,this.model.init()},setVASTController:function(e){NYTD.Video.Validation.isEmpty(this.vastController)&&(this.logger.info("setVASTController"),this.vastController=new NYTD.Video.Ad.Controller.VASTController({player:this.model.player}),this.vastController.getSubscription().subscribe(NYTD.Video.Ad.Controller.VASTController.COMPLETE,NYTD.Video.Utils.bind(this.onVASTComplete,this)),this.logger.debug("setVastController - VAST Controller initialized..."))},onVASTComplete:function(e){NYTD.Video.Validation.isEmpty(e)||NYTD.Video.Validation.isEmpty(e.vast)?(this.logger.error("VAST response was empty"),this.resumeContent()):this.model.adModule.showAd(e.vast);try{this.logger.info("onVASTComplete"),this.vastController.getSubscription().cancel(NYTD.Video.Ad.Controller.VASTController.COMPLETE,NYTD.Video.Utils.bind(this.onVASTComplete,this)),this.vastController.kill(),this.vastController=null,this.clientSide=null}catch(t){var n=t;this.logger.error("onVASTComplete",n)}},registerListeners:function(){var e=this.model.player.getSubscription();e.subscribe(this.videoEvents.TEMPLATE_READY,NYTD.Video.Utils.bind(this.onTemplateReady,this)),e.subscribe(this.videoEvents.TEMPLATE_LOADED,NYTD.Video.Utils.bind(this.onTemplateLoaded,this)),e.subscribe(this.videoEvents.EXTERNAL_AD,NYTD.Video.Utils.bind(this.onExternalAd,this)),e.subscribe(this.videoEvents.DESTROYING,NYTD.Video.Utils.bind(this.onDestroyed,this)),e.subscribe(this.videoEvents.AD_START,NYTD.Video.Utils.bind(this.onAdStart,this)),e.subscribe(this.videoEvents.AD_COMPLETE,NYTD.Video.Utils.bind(this.onAdComplete,this)),e.subscribe(this.videoEvents.AD_PROGRESS,NYTD.Video.Utils.bind(this.onAdProgress,this)),e.subscribe(this.videoEvents.VIDEO_LOAD,NYTD.Video.Utils.bind(this.onVideoLoaded,this)),e.subscribe(this.videoEvents.STREAM_START,NYTD.Video.Utils.bind(this.onStreamStart,this)),this.logger.debug("registerListeners")},unregisterListeners:function(){var e=this.model.player.getSubscription();e.cancel(this.videoEvents.TEMPLATE_READY,NYTD.Video.Utils.bind(this.onTemplateReady,this)),e.cancel(this.videoEvents.TEMPLATE_LOADED,NYTD.Video.Utils.bind(this.onTemplateLoaded,this)),e.cancel(this.videoEvents.EXTERNAL_AD,NYTD.Video.Utils.bind(this.onExternalAd,this)),e.cancel(this.videoEvents.DESTROYING,NYTD.Video.Utils.bind(this.onDestroyed,this)),e.cancel(this.videoEvents.AD_START,NYTD.Video.Utils.bind(this.onAdStart,this)),e.cancel(this.videoEvents.AD_COMPLETE,NYTD.Video.Utils.bind(this.onAdComplete,this)),e.cancel(this.videoEvents.AD_PROGRESS,NYTD.Video.Utils.bind(this.onAdProgress,this)),e.cancel(this.videoEvents.VIDEO_LOAD,NYTD.Video.Utils.bind(this.onVideoLoaded,this)),e.cancel(this.videoEvents.STREAM_START,NYTD.Video.Utils.bind(this.onStreamStart,this)),this.logger.debug("unregisterListeners")},onTemplateReady:function(e){this.logger.debug("onTemplateReady",e);try{this.model.adModule=e.player.getAdModule(),this.model.contentModule=e.player.getContentModule(),this.model.videoModule=e.player.getVideoModule()}catch(t){var n=t;this.logger.error("onTemplateLoaded",n)}this.model.adModule.enableExternalAds(!0)},onTemplateLoaded:function(e){this.logger.debug("onTemplateLoaded",e)},onExternalAd:function(e){this.logger.info("onExternalAd",e),this.fetch()},onCuePoint:function(e){this.logger.info("onCuePoint",e)},onDestroyed:function(e){this.kill()},onAdStart:function(e){this.logger.info("onAdStart",e)},onAdComplete:function(e){this.logger.info("onAdComplete",e),this.removeVideoAdCountdown()},onAdProgress:function(e){if(this.showVideoAdCountDown){this.isVideoAdCountdownVisible||(NYTD.Video.Validation.isEmpty(this.model.adModule)||(this.videoAdDuration=Math.floor(this.model.adModule.getCurrentAdProperties().duration)),this.videoAdCountdownHTML===null&&this.buildVideoAdNotice(this.videoAdDuration),this.addVideoAdCountdown());if(this.videoAdCountdown&&e&&e.obj&&e.obj.position>=0){if(this.model&&!NYTD.Video.Validation.isEmpty(this.model.adModule)){var t=Math.floor(this.model.adModule.getCurrentAdProperties().duration);t!==this.videoAdDuration&&(this.videoAdDuration=t,this.model.player.defaultProps.adDurationBeforeSkippable===null&&(this.adDurationBeforeSkippable=Math.floor(this.videoAdDuration/2)))}var n=Math.floor(e.obj.position),r=parseInt(this.videoAdDuration-n,10);if(r>=0){var i="";this.videoAdDuration>=this.skippableAdDuration&&n<this.adDurationBeforeSkippable?(this.skipAdCopy[1]=this.adDurationBeforeSkippable-n,i=this.skipAdCopy):(this.adCountdownCopy[1]=r,i=this.adCountdownCopy),i[1]<10&&(i[1]=["0",i[1]].join("")),this.videoAdCountdown.html(i.join(""))}this.videoAdDuration>=this.skippableAdDuration&&n>=this.adDurationBeforeSkippable&&this.showVideoSkipButton()}}},onVideoLoaded:function(e){this.logger.info("onVideoLoaded",e),this.removeVideoAdCountdown()},onStreamStart:function(e){this.logger.info("onStreamStart",e),this.removeVideoAdCountdown()},adRequestTimedout:!1,fetch:function(e){this.logger.debug("fetch - Fetching ads from ADX");var t=this,n=this.buildADXRequestURL(this.model.callback);NYTD.Video.$.ajax({url:n,dataType:"jsonp",timeout:5e3,success:function(e){t.success(e)},error:function(){t.adxError("No ads returned")}})},fetchVASTTag:function(){var e=this.model.videoModule.getCurrentVideo();this.setVASTController(this.model.bigAdContainer);var t=/[^\d]+/.test(e.referenceId)?e.id:e.referenceId,n={pageUrl:"http://video.nytimes.com",videoId:t,videoTitle:e.displayName,playerWidth:this.model.videoModule.getDisplayWidth(),playerHeight:this.model.videoModule.getDisplayHeight(),vastUrl:this.model.videoPlayerAd};this.vastController.fetch(n),this.logger.info("fetchVASTTag - Fetching VAST tag",n)},setPageUrl:function(){typeof NYTD.env=="undefined"||NYTD.env&&NYTD.env!=="production"?this.model.pageUrl="http://video.nytimes.com":this.model.pageUrl=window.location.href.toString()},success:function(e){if(!e||!e.status||e.status.length<=0||!e.status[0].videoads||e.status[0].videoads.status===0){this.logger.warn("No ads found."),this.adxError("No ads found");return}var t=NYTD.Video.Validation.isEmpty;if(e&&!t(e.response)&&!t(e.response.videoads)&&!t(e.response.videoads.ads)){e.response.videoads.ads.ADX_CLIENTSIDE&&this.dropADXClientSide(e.response.videoads.ads.ADX_CLIENTSIDE);var n=!1;t(e.response.videoads.ads.VideoPlayerAd)||(n=!0,this.model.videoPlayerAd=e.response.videoads.ads.VideoPlayerAd,this.clientSide=e.response.videoads.ads.ADX_CLIENTSIDE||null,/^http:\/\//.test(this.model.videoPlayerAd)?this.fetchVASTTag():this.showAds({videoPlayerAd:this.model.videoPlayerAd})),t(e.response.videoads.ads.VideoBigAd)?n||this.resumeContent():(this.model.bigAd=e.response.videoads.ads.VideoBigAd,this.showAds({videoBigAd:this.model.bigAd}),n||(this.logger.info("Not video ads available. Displaying big ad only"),this.resumeContent()))}else this.adxError("No ads found")},showAds:function(e){if(typeof e=="undefined"||null===e){this.resumeContent();return}e.videoPlayerAd&&this.model.adModule.showAd(e.videoPlayerAd),e.videoBigAd&&this.renderAd(e.videoBigAd)},setBCRoadSync:function(){var e=this;window.bcsyncroadblock=function(t){e.bcsyncroadblock(t)},this.logger.debug("setBCRoadSync")},bcsyncroadblock:function(e){if(typeof this.model.bigAdContainer=="undefined"||null===this.model.bigAdContainer){this.logger.warn("BigAd container not specified...");return}this.logger.debug("bcsyncroadblock",e);var t=NYTD.Video.$,n=t.parseXML(e),r=n.getElementsByTagName("CompanionAds"),i=r.length,s=0,o=0,u=null,a=null,f=null,l=null,c=null,h="",p=null,d=/^http:\/\//,v=NYTD.Video.Sanitizer,m="",g="";for(var y=0;y<i;y++){g=r[y].getElementsByTagName("Companion");if(g&&g.length>0){var b=g.length;for(var w=0;w<b;w++){var E=g[w];if(!E)continue;p={},s=parseInt(E.getAttribute("width"),10),o=parseInt(E.getAttribute("height"),10),m=E.getAttribute("creativeType");if(s===this.model.bannerWidth&&o===this.model.bannerHeight){u=t(t(E).find("HTMLResource")).first().text(),a=t(t(E).find("IFrameResource")).first().text(),f=t(t(E).find("CompanionClickThrough")).first().text(),l=t(t(E).find("Tracking")),c=t(t(E).find("StaticResource")).first(),c&&(p.src=v.cleanCDATA(t(c).text()),p.creativeType=t(c).attr("creativeType")),p.tracking=l?l:null,p.iframe=v.cleanCDATA(a),p.href=f,p.HTMLResource=v.cleanCDATA(u),d.test(u)&&!p.iframe?(this.logger.warn("The HTMLResource element was determined to be a URL. Converting to an IFrameResource.",u),p.iframe=u):p.HTMLResource=u;break}}}}null!==p?this.renderAd(p):this.logger.error("Big ad was not found. Possibly due to invalid banner dimension.",r)},renderAd:function(e){if(NYTD.Video.Validation.isEmpty(this.model.bigAdContainer))return this.logger.warn("renderAd","Big ad container element was not specified. Companion ad will not be displayed"),!1;if(NYTD.Video.Validation.isEmpty(e))return this.logger.error("renderAd","It appears the ad property is empty",e),!1;this.logger.debug("renderAd",e),this.model.bigAdContainer.innerHTML="";if(e.src&&e.href){if(!e.creativeType||e.creativeType)this.model.imageRegExp.test(e.creativeType)===!0?this.renderImageAd(e):e.creativeType==="application/x-shockwave-flash"&&this.renderSWFAd(e)}else e.iframe?this.renderIFrameAd(e):e.HTMLResource?this.renderHTMLAd(e):this.renderHTMLAd(e);return!0},renderImageAd:function(e){this.logger.debug("renderImageAd",e);var t=document.createElement("img");t.setAttribute("src",e.src),t.setAttribute("width",e.width),t.setAttribute("height",e.height);var n=document.createElement("a");n.setAttribute("href",e.href),n.appendChild(t),this.model.bigAdContainer.appendChild(n),this.renderImageTracker()},renderImageTracker:function(e){var t=NYTD.Video.$,n=e.tracking,r=n.length;for(var i=0;i<r;i++){var s=n[i];if(typeof s=="undefined"||t(s).attr("event")!=="creativeView")continue;var o=NYTD.Video.Sanitizer.cleanCDATA(t(s).text()),u=document.createElement("img");u.setAttribute("src",o),u.setAttribute("width","1px"),u.setAttribute("height","1px"),u.style.visibility="hidden",documentHead.append(u),NYTD.Video.Logger.info("Dropping creativeView beacon",o)}},renderClickDiv:function(e){var t=NYTD.Video.$,n=document.createElement("div");this.model.bigAdContainer.appendChild(n),e.href&&t(n).addClass("overlay").bind("mouseenter",function(e){t(this).css({cursor:"pointer"}).css({cursor:"hand"})}).bind("click",function(t){window.location.href=e.href})},renderSWFAd:function(e){var t=[{src:NYTD.Video.Libs.SWFObject,type:"jQuery.flash"}];NYTD.Video.Utils.loadDependencies(t,function(t){swfobject.embedSWF(e.src,NYTD.Video.$(this.model.bigAdContainer).attr("id"),"300","250","9.0.0"),this.logger.info("Dependencies loaded",t)},this)},renderIFrameAd:function(e){this.logger.debug("renderIFrameAd",e);var t=NYTD.Video.$(document.createElement("iframe"));t.attr("width",this.model.iframeWidth).attr("height",this.model.iframeHeight).attr("frameBorder",this.model.iframeBorder).attr("scrolling",this.model.iframeScrolling).attr("src",this.model.iframeSrc).attr("marginWidth",this.model.iframeMarginWidth).attr("marginHeight",this.model.iframeMarginHeight).attr("noresize",this.model.iframeNoResize),NYTD.Video.$(this.model.bigAdContainer).append(t),t.attr("src",e.iframe),this.renderClickDiv(e)},renderHTMLAd:function(e){this.logger.debug("renderHTMLAd",e),e.HTMLResource?this.model.bigAdContainer.innerHTML=e.HTMLResource:this.model.bigAdContainer.innerHTML=e},adxError:function(e){this.logger.error("adxError",e),this.resumeContent()},resumeContent:function(){this.logger.debug("resumeContent",this.model.adModule),this.model.adModule.resumeAfterExternalAd()},kill:function(){NYTD.Video.Validation.isEmpty(window[this.model.callback])||(window[this.model.callback]=null),this.unregisterListeners(),this.removeADXTrackingContainer(),this.removeBigAd()}}),this.FlashAdController=function(e){var t=new NYTD.Video.Ad.Controller.FlashAdPrivateController(e)}}.call(NYTD.Video.Ad.Controller),function(){"use strict";this.HTML5AdController=this.AbstractAdController.extend({adsLoader:null,el:null,elParent:null,adsManager:null,adsLoaded:!1,adDisplayContainer:null,currentAd:null,adStarted:!1,initialize:function(e){this.logger=NYTD.Video.Logger.get("NYTD.Video.Ad.Controller.HTML5AdController"),this.videoEvents=NYTD.Video.VideoEvents,this.setup(e),this.logger.debug("Ad Controller, initialization complete")},registerListeners:function(){this.logger.debug("registerListeners");var e=this.model.player.getSubscription();e.subscribe(NYTD.Video.VideoEvents.EXTERNAL_AD,NYTD.Video.Utils.bind(this.onExternalAd,this)),e.subscribe(NYTD.Video.VideoEvents.DESTROYING,NYTD.Video.Utils.bind(this.onDestroyed,this)),e.subscribe(NYTD.Video.VideoEvents.TEMPLATE_READY,NYTD.Video.Utils.bind(this.onTemplateReady,this)),e.subscribe(NYTD.Video.VideoEvents.STREAM_START,NYTD.Video.Utils.bind(this.onStreamStart,this))},unregisterListeners:function(){this.logger.debug("unregisterListeners");var e=this.model.player.getSubscription();e.cancel(NYTD.Video.VideoEvents.EXTERNAL_AD,NYTD.Video.Utils.bind(this.onExternalAd,this)),e.cancel(NYTD.Video.VideoEvents.DESTROYING,NYTD.Video.Utils.bind(this.onDestroyed,this)),e.cancel(NYTD.Video.VideoEvents.TEMPLATE_READY,NYTD.Video.Utils.bind(this.onTemplateReady,this)),e.cancel(NYTD.Video.VideoEvents.STREAM_START,NYTD.Video.Utils.bind(this.onStreamStart,this))},onTemplateReady:function(e){this.logger.debug("HTML5::onTemplateReady",e);try{this.model.adModule=e.player.getAdModule(),this.model.contentModule=e.player.getContentModule(),this.model.videoModule=e.player.getVideoModule()}catch(t){var n=t;this.logger.error("HTML5::onTemplateReady Error",n)}this.model.adModule.enableExternalAds(!0)},onExternalAd:function(e){this.fetch()},setCallback:function(){NYTD.Video.Validation.isEmpty(this.model.callback)&&(this.model.callback=NYTD.Video.Utils.generateCallbackName("adx_video_success"))},onStreamStart:function(e){this.logger.info("HTML5::onStreamStart",e),this.removeHTML5VideoAdCountdown()},onAdsLoadError:function(e){this.logger.info("HTML5::onAdsLoadError",e);var t="";if(e.hasOwnProperty("message")&&e.hasOwnProperty("data")){this.logger.error("Ad Error Msg. ",e.message);var n=e.data;if(n){var r=null;typeof n.getError=="function"&&(r=n.getError(),typeof r.getMessage=="function"&&this.logger.error("Ad Error Msg. ",r.getMessage()),typeof r.getType=="function"&&this.logger.error("Ad Error Type. ",r.getType()),typeof r.getErrorCode=="function"&&(this.logger.error("Ad Error Code. ",r.getErrorCode()),t=r.getErrorCode()),typeof r.getInnerError=="function"&&this.logger.error("Ad Inner Error. ",r.getInnerError()))}}t!==3102&&(this.resumeContent(),this.getSubscription().notify(NYTD.Video.Ad.Controller.HTML5AdController.ERROR,e))},onAdProgress:function(e){if(this.adsManager){var t=Math.floor(this.adsManager.getRemainingTime());this.model&&this.model.player&&this.model.player.controlsModule&&this.model.player.controlsModule.updateDuration(this.model.player.timeFormat(t))}var n=this.currentAd.getDuration()-this.adsManager.getRemainingTime();if(this.showVideoAdCountDown&&n!==0){this.isVideoAdCountdownVisible||(this.model.player.object&&(this.videoAdDuration=Math.floor(this.currentAd.getDuration())),this.videoAdCountdownHTML===null&&this.buildVideoAdNotice(this.videoAdDuration),this.addHTML5VideoAdCountdown());if(this.videoAdCountdown){var r=Math.floor(this.currentAd.getDuration());r!==this.videoAdDuration&&(this.videoAdDuration=r,this.model.player.defaultProps.adDurationBeforeSkippable===null&&(this.adDurationBeforeSkippable=Math.floor(this.videoAdDuration/2)));var i=Math.floor(n);if(i>=0){var s=Math.floor(i),o=parseInt(this.videoAdDuration-s,10);if(o>=0){var u="";this.videoAdDuration>=this.skippableAdDuration&&s<this.adDurationBeforeSkippable?(this.skipAdCopy[1]=this.adDurationBeforeSkippable-s,u=this.skipAdCopy):(this.adCountdownCopy[1]=o,u=this.adCountdownCopy),u[1]<10&&(u[1]=["0",u[1]].join("")),this.videoAdCountdown.html(u.join(""))}this.videoAdDuration>=this.skippableAdDuration&&s>=this.adDurationBeforeSkippable&&this.showVideoSkipButton()}}}},addHTML5VideoAdCountdown:function(){this.logger.info("addHTML5VideoAdCountdown"),this.addVideoAdCountdown();var e=this;this.videoAdCountdownHTML&&(NYTD.Video.Validation.isIOS()||NYTD.Video.Validation.isAndroid()?this.videoAdCountdownHTML.on("touchend",function(t){e.logger.info("touchend video ad countdown"),e.model.player.controlsModule.fadeInControls()}):(this.videoAdCountdownHTML.on("mouseenter",function(t){e.logger.info("mouseenter video ad countdown"),e.model.player.controlsModule.fadeInControls()}),this.videoAdCountdownHTML.on("mouseleave",function(t){e.logger.info("mouseleave video ad countdown"),e.model.player.controlsModule.startFadeOutTimer()})))},removeHTML5VideoAdCountdown:function(){this.logger.info("removeHTML5VideoAdCountdown"),clearInterval(this.progressTimer),this.removeVideoAdCountdown()},reloadContentAndPlay:function(){this.logger.info("reloadContentAndPlay"),this.adStarted=!1,this.removeHTML5VideoAdCountdown(),this.adsManager&&this.adsManager.destroy(),this.adsLoaded=!1,this.model&&this.model.player&&(this.model.player.defaultProps.useNativeControls?this.model.player.object.controls=!0:this.model.player.controlsModule&&(this.model.player.videoModule.mediaIsLive()?this.model.player.controlsModule.configureForLiveVideo():this.model.player.controlsModule.configureForVideo()),this.model.player.object.removeAttribute("src"),this.model.player.videoModule.mediaIsLive()&&this.model.player.loadLiveVideo(),this.model.player.isAdPlaying=!1,this.model.player.isAdInitializing=!1,this.model.player.object.load(),NYTD.Video.$.browser.msie?parseInt(NYTD.Video.$.browser.version,10)>=9&&this.model.player.object.play():this.model.player.autoPlay())},onAdsManagerLoaded:function(e){this.logger.info("onAdsManagerLoaded",e);var t=this,n=document.getElementById(this.model.player.getProps().id);this.adsManager=e.getAdsManager(n);var r=function(e){t.logger.info("HTML5::onAdLoaded",e)},i=function(e){t.logger.info("HTML5::onAdsComplete",e),t.adStarted=!1,t.removeHTML5VideoAdCountdown(),t.getSubscription().notify(NYTD.Video.Ad.Controller.HTML5AdController.COMPLETE,{})},s=function(e){t.logger.info("Ad All Ads Completed",e)},o=function(e){t.logger.info("Ad Started",e),t.adStarted=!0;var n=e.getAd();n.isLinear()&&(t.progressTimer=setInterval(function(){t.onAdProgress()},300)),t.model&&t.model.player&&(t.model.player.isAdPlaying=!0,t.model.player.isAdInitializing=!1),t.model.player.defaultProps.useNativeControls?t.model.player.object.controls=!1:t.model.player.controlsModule&&t.model.player.controlsModule.configureForAd(),t.getSubscription().notify(NYTD.Video.Ad.Controller.HTML5AdController.STARTED,{});if(!NYTD.Video.Validation.isEmpty(t.model.bigAdContainer)){var r=n.getCompanionAds(300,250,{resourceType:google.ima.CompanionAdSelectionSettings.ResourceType.STATIC,creativeType:google.ima.CompanionAdSelectionSettings.CreativeType.IMAGE});if(r.length>0){var i=r[0],s=i.getContent();t.renderHTMLAd(s)}}},u=function(e){t.logger.info("Ad Paused",e),t.model.player.defaultProps.useNativeControls&&(t.model.player.object.controls=!0),t.getSubscription().notify(NYTD.Video.Ad.Controller.HTML5AdController.PAUSED,{})},a=function(e){t.logger.info("Ad Clicked",e),t.model.player.defaultProps.useNativeControls&&(t.model.player.object.controls=!0)},f=function(e){t.logger.info("onPauseContentRequested: Content Paused",e),t.model&&t.model.player&&(t.model.player.isAdPlaying=!0,t.model.player.isAdInitializing=!1,t.model.player.pause()),t.currentAd=e.getAd()},l=function(e){t.logger.info("onResumeContentRequested: Content Resumed",e),t.reloadContentAndPlay()},c=function(e){t.logger.info("Ad Error",e);var n=null;typeof e.getError=="function"&&(n=e.getError(),typeof n.getMessage=="function"&&t.logger.error("Ad Error Msg. ",n.getMessage()),typeof n.getType=="function"&&t.logger.error("Ad Error Type. ",n.getType()),typeof n.getErrorCode=="function"&&t.logger.error("Ad Error Code. ",n.getErrorCode()),typeof n.getInnerError=="function"&&t.logger.error("Ad Inner Error. ",n.getInnerError())),t.reloadContentAndPlay(),t.getSubscription().notify(NYTD.Video.Ad.Controller.HTML5AdController.ERROR,e)},h=function(e){t.logger.info("Ad Load Error",e),t.reloadContentAndPlay(),t.getSubscription().notify(NYTD.Video.Ad.Controller.HTML5AdController.ERROR,e)},p=function(e){t.logger.info("Ad Play Error",e),t.reloadContentAndPlay(),t.getSubscription().notify(NYTD.Video.Ad.Controller.HTML5AdController.ERROR,e)};this.adsManager.addEventListener(google.ima.AdEvent.Type.COMPLETE,i,!1),this.adsManager.addEventListener(google.ima.AdEvent.Type.ALL_ADS_COMPLETED,s,!1),this.adsManager.addEventListener(google.ima.AdEvent.Type.STARTED,o,!1),this.adsManager.addEventListener(google.ima.AdEvent.Type.PAUSED,u,!1),this.adsManager.addEventListener(google.ima.AdEvent.Type.CLICK,a,!1),this.adsManager.addEventListener(google.ima.AdEvent.Type.LOADED,r,!1),this.adsManager.addEventListener(google.ima.AdEvent.Type.CONTENT_PAUSE_REQUESTED,f,!1),this.adsManager.addEventListener(google.ima.AdEvent.Type.CONTENT_RESUME_REQUESTED,l,!1),this.adsManager.addEventListener(google.ima.AdErrorEvent.Type.AD_ERROR,c,!1),this.adsManager.addEventListener(google.ima.AdError.Type.AD_LOAD,h,!1),this.adsManager.addEventListener(google.ima.AdError.Type.AD_PLAY,p,!1),this.adsLoaded=!0,this.model.player.contentInitialized?(this.logger.info("Content initialized",this.model.player.contentInitialized),this.startAds()):(this.logger.info("Content NOT initialized. Wait...",this.model.player.contentInitialized),NYTD.Video.Validation.isIOS()&&(this.logger.info("IOS Start AutoPlay"),this.model.player.autoPlay()))},startAds:function(){this.logger.info("startAds");try{this.model.player.object.pause();var e=document.getElementById(this.model.player.getProps().id);e.controls=!1,this.adsManager.init(this.model.player.defaultProps.width,this.model.player.defaultProps.height,google.ima.ViewMode.NORMAL),this.adsManager.start()}catch(t){var n=t;this.logger.error(n),this.onAdsLoadError({message:"Ad Error Catch",data:n})}},stopAd:function(e){this.logger.info("Stop Ad",e),this.adsManager&&this.adsManager.stop()},resumeAd:function(e){this.logger.info("Resume Ad",e),this.adsManager&&this.adsManager.resume()},pauseAd:function(e){this.logger.info("Pause Ad",e),this.adsManager&&this.adsManager.pause()},setVASTController:function(e){this.logger.debug("setVastController"),NYTD.Video.Validation.isEmpty(this.vastController)&&(this.vastController=new NYTD.Video.Ad.Controller.VASTController,this.vastController.getSubscription().subscribe(NYTD.Video.Ad.Controller.VASTController.COMPLETE,NYTD.Video.Utils.bind(this.onVASTComplete,this)))},onDestroyed:function(e){this.kill()},adxError:function(e){this.logger.error("adxError",e),this.resumeContent()},fetch:function(e){this.logger.debug("fetch - Fetching ads from ADX");var t=this;this.doFetch=function(e){t.logger.debug("fetch - Fetching ads from ADX"),NYTD.Video.Validation.isEmpty(window[t.model.callback])&&(window[t.model.callback]=function(e){t.logger.info("Got response from ADX 1",e),t.success(e)});var n=t.buildADXRequestURL(t.model.callback);NYTD.Video.$.ajax({url:n,dataType:"jsonp",timeout:5e3,success:function(e){t.logger.info("Got response from ADX 2",e),t.success(e)},error:function(){t.adxError("No ads returned")}})};if(!this.initialized){this.onGoogleAPILoaded=function(){t.logger.info("onGoogleSDKLoaded loaded"),t.initialized=!0;var e=document.getElementById(t.model.player.getProps().id);t.adDisplayContainer=new google.ima.AdDisplayContainer(this.model.player.html5VideoAdContainer,e,e),t.adDisplayContainer.initialize(),t.adsLoader=new google.ima.AdsLoader(t.adDisplayContainer),t.adsLoader.addEventListener(google.ima.AdErrorEvent.Type.AD_ERROR,function(e){t.onAdsLoadError({message:"Ads Load Error",data:e})},!1),t.adsLoader.addEventListener(google.ima.AdsManagerLoadedEvent.Type.ADS_MANAGER_LOADED,function(e){t.onAdsManagerLoaded.call(t,e)},!1),t.doFetch()};var n=[{src:NYTD.Video.Libs.GoogleJSAPI,type:"google"}];NYTD.Video.Utils.loadDependencies(n,function(e){t.logger.info("Dependencies loaded",e),t.onGoogleAPILoaded()},this)}else this.doFetch()},success:function(e){this.logger.info("SUCCESS",e);var t=NYTD.Video.Validation.isEmpty;e&&!t(e.response)&&!t(e.response.videoads)&&!t(e.response.videoads.ads)&&e.response.videoads.ads.ADX_CLIENTSIDE&&this.dropADXClientSide(e.response.videoads.ads.ADX_CLIENTSIDE);if(!e||!e.status||e.status.length<=0||!e.status[0].videoads||e.status[0].videoads.status===0){this.onAdsLoadError({message:"No ads found",data:e});return}e&&e.response&&e.response.videoads&&e.response.videoads.ads&&e.response.videoads.ads.VideoPlayerAd?(this.model.videoPlayerAd=e.response.videoads.ads.VideoPlayerAd,typeof this.model.videoPlayerAd=="string"&&/^<!--.*-->/.test(this.model.videoPlayerAd)&&(this.model.videoPlayerAd=this.model.videoPlayerAd.replace(/^<!--.*-->/,"")),/^http:\/\//.test(this.model.videoPlayerAd)||/^<VAST/.test(this.model.videoPlayerAd)?this.fetchVASTTag():this.onAdsLoadError({message:"No ads found",data:e})):this.onAdsLoadError({message:"VideoPlayerAd was not found in response",data:e})},fetchVASTTag:function(){if(NYTD.Video.Validation.isEmpty(this.model.videoPlayerAd))this.onAdsLoadError({message:"Vast tag is not set",data:{}});else{var e=new google.ima.AdsRequest;/^http:\/\//.test(this.model.videoPlayerAd)?e.adTagUrl=this.model.videoPlayerAd:/^<VAST/.test(this.model.videoPlayerAd)&&(e.adsResponse=this.model.videoPlayerAd,e.adTagUrl=""),e.linearAdSlotWidth=this.model.player.defaultProps.width,e.linearAdSlotHeight=this.model.player.defaultProps.height,e.nonLinearAdSlotWidth=this.model.player.defaultProps.width,e.nonLinearAdSlotHeight=this.model.player.defaultProps.height,this.logger.info("Request Ad using Google API"),this.adsManager&&(this.logger.info("Unload/Destroy previous ad"),this.adsManager.destroy(),this.adsLoaded=!1);try{this.adsLoader.requestAds(e)}catch(t){this.logger.info("error requesting Ads",t)}}},renderHTMLAd:function(e){this.logger.debug("renderHTMLAd",e),e.HTMLResource&&!NYTD.Video.Validation.isEmpty(this.model.bigAdContainer)?this.model.bigAdContainer.innerHTML=e.HTMLResource:this.model.bigAdContainer.innerHTML=e},resumeContent:function(){this.logger.debug("resumeContent"),this.model.player.isAdInitializing=!1,this.model.player.isAdPlaying=!1,this.model.player.adModule.resumeAfterExternalAd()},kill:function(){this.logger.warn("onDestroyed"),this.unregisterListeners(),this.removeADXTrackingContainer(),this.removeBigAd()}}),NYTD.Video.Ad.Controller.HTML5AdController.COMPLETE="complete",NYTD.Video.Ad.Controller.HTML5AdController.STARTED="started",NYTD.Video.Ad.Controller.HTML5AdController.PAUSED="paused",NYTD.Video.Ad.Controller.HTML5AdController.ERROR="error"}.call(NYTD.Video.Ad.Controller),function(){"use strict";return this.VASTPrivateController=Backbone.Model.extend({videoEvents:null,validation:null,model:null,subscription:null,sanitizer:NYTD.Video.Sanitizer,documentHead:NYTD.Video.DOCUMENT_HEAD,logger:null,player:null,initialize:function(e){this.validation=NYTD.Video.Validation,this.videoEvents=NYTD.Video.VideoEvents;if(this.validation.isEmpty(e)||this.validation.isEmpty(e.player))throw new Error("Missing one or more required parameters");this.subscription=new NYTD.Subscription,this.logger=NYTD.Video.Logger.get("NYTD.Video.VASTController"),this.player=e.player,this.setVASTModel(),this.logger.info("settingVASTCallback"),this.model.callback=NYTD.Video.Utils.generateCallbackName([this.player.getObjectId(),"_vast"].join(""));var t=this;window[this.model.callback]=function(e){t.logger.info("Received VAST response",e),t.subscription.notify(NYTD.Video.Ad.Controller.VASTController.COMPLETE,{vast:e})},this.logger.debug("init - Initializing complete")},resetObjectState:function(){this.model=null,this.subscription=null,this.sanitizer=NYTD.Video.Sanitizer,this.documentHead=NYTD.Video.DOCUMENT_HEAD,this.logger=null,this.player=null},setVASTModel:function(){this.model=new NYTD.Video.Ad.Model.VASTModel,this.model.init()},fetch:function(e){if(this.validation.isEmpty(e)||this.validation.isEmpty(e.videoId)||this.validation.isEmpty(e.videoTitle)||this.validation.isEmpty(e.vastUrl)||this.validation.isEmpty(e.playerWidth)||this.validation.isEmpty(e.playerHeight)){var t=new Error("Missing one or more required parameters");throw this.logger.error("fetch - There was an error",t),t}e.pageUrl&&(this.model.pageUrl=e.pageUrl),this.model.videoTitle=e.videoTitle,this.model.videoId=e.videoId,this.model.vastURL=e.vastUrl,this.model.playerWidth=e.playerWidth,this.model.playerHeight=e.playerHeight;var n=this.buildProxyRequestURL();this.dropScriptTag(n)},buildProxyRequestURL:function(){var e=[this.model.proxyBaseURL,"&cu=",encodeURIComponent(this.model.pageUrl),"&pw=",this.model.playerWidth,"&ph=",this.model.playerHeight,"&vu=",encodeURIComponent(this.model.vastURL),"&vt=",this.model.videoTitle,"&vi=",this.model.videoId,"&callback=",this.model.callback].join("");return this.logger.debug(["buildProxyRequestURL - ",e].join("")),e},dropScriptTag:function(e){this.logger.debug("dropScriptTag - ",e);var t=document.createElement("script");t.setAttribute("src",e),this.documentHead.appendChild(t)},getSubscription:function(){return this.subscription},kill:function(){window[this.model.callback]&&(window[this.model.callback]=null),this.resetObjectState()}}),this.VASTController=function(e){this.COMPLETE="vast:controller:complete";var t=new NYTD.Video.Ad.Controller.VASTPrivateController(e);return{fetch:function(e){t.fetch(e)},getSubscription:function(){return t.getSubscription()},kill:function(){t.kill()}}},NYTD.Video.Ad.Controller.VASTController.COMPLETE="vast:controller:complete",this}.call(NYTD.Video.Ad.Controller),NYTD.Video.VideoEvents={INIT:"init",RENDERED:"rendered",REMOVED:"removed",DESTROY:"destroy",DESTROYING:"destroying",DESTROYED:"destroyed",STOP_OTHER_PLAYERS:"stop_other_players",DISABLE_OTHER_PLAYERS:"disable_other_players",ENABLE_OTHER_PLAYERS:"enable_other_players",PLAY:"play",PAUSED:"paused",RESUMED:"resumed",TEMPLATE_LOADED:"template_loaded",TEMPLATE_READY:"template_ready",CONTENT_LOAD:"content_loaded",CUE:"cue",VIDEO_LOAD:"video_load",VIDEO_START:"video_start",VIDEO_PAUSED:"video_paused",STREAM_START:"stream_start",VIDEO_COMPLETE:"video_complete",FULLSCREEN:"fullscreen",EXIT_FULLSCREEN:"exit_fullscreen",PLAYLIST_LOAD:"playlist_load",MEDIA_BEGIN:"media_begin",MEDIA_COLLECTION_LOAD:"media_collection_load",MEDIA_LOAD:"media_load",MEDIA_PROGRESS:"media_progress",MUTED:"media_muted",UNMUTED:"media_unmuted",MUTE_CHANGE:"media_mute_change",MEDIA_ERROR:"media_error",BLOG_POST_CLICK:"blog_post_click",COPY_CODE:"copy_code",COPY_LINK:"copy_link",ICON_MENU_CLOSE:"icon_menu_close",ICON_MENU_OPEN:"icon_menu_open",MENU_PAGE_CLOSE:"menu_page_close",MENU_PAGE_OPEN:"menu_page_open",OVERLAY_MENU_CLOSE:"overlay_menu_close",OVERLAY_MENU_OPEN:"overlay_menu_open",OVERLAY_MENU_PLAY_CLICK:"overlay_menu_play_click",SEND_EMAIL_CLICK:"send_email_click",VIDEO_REQUEST:"video_request",AD_COMPLETE:"ad_complete",AD_PAUSE:"ad_pause",AD_START:"ad_start",AD_RESUME:"ad_resume",AD_PROGRESS:"ad_progress",AD_CLICK:"ad_click",AD_POSTROLLS_COMPLETE:"ad_postrolls_complete",AD_RECEIVED:"ad_received",AD_RULES_READY:"ad_rules_ready",EXTERNAL_AD:"external_ad",AD_SKIPPED:"ad_skipped",PLAY_CLICKED:"play_clicked",DFXP_LOAD_ERROR:"dfxp_load_error",DFXP_LOAD_SUCCESS:"dfxp_load_success",SEARCH_ERROR:"search_error",SEARCH_RESULT:"search_result",ADX_MODULE_READY:"adx_module_ready",POLL_CHECK_COMPLETE:"poll_check_complete"},function(){this.AbstractMetrics=Backbone.Model.extend({player:null,info:null,currentVideo:null,tracked:!1,autoTracked:!1,body:null,logger:null,videoFramework:NYTD.Video,videoFrameworkEvents:NYTD.Video.VideoEvents,videoFrameworkValidation:NYTD.Video.Validation,videoFrameworkUtils:NYTD.Video.Utils,isAd:!1,initialize:function(e){},resetObjectState:function(){this.player=null,this.info=null,this.currentVideo=null,this.tracked=!1,this.autoTracked=!1,this.trackedUptProgress=!1,this.uptContainer=null,this.body=null},registerListeners:function(){this.logger.debug("registerListeners");var e=this.player.getSubscription();e.subscribe(this.videoFrameworkEvents.TEMPLATE_READY,this.videoFrameworkUtils.bind(this.onTemplateReady,this)),e.subscribe(this.videoFrameworkEvents.DESTROY,this.videoFrameworkUtils.bind(this.onDestroy,this)),this.onStreamStart&&e.subscribe(this.videoFrameworkEvents.STREAM_START,this.videoFrameworkUtils.bind(this.onStreamStart,this)),this.onVideoStart&&e.subscribe(this.videoFrameworkEvents.VIDEO_START,this.videoFrameworkUtils.bind(this.onVideoStart,this)),this.onVideoComplete&&e.subscribe(this.videoFrameworkEvents.VIDEO_COMPLETE,this.videoFrameworkUtils.bind(this.onVideoComplete,this)),this.onVideoProgress&&e.subscribe(this.videoFrameworkEvents.MEDIA_PROGRESS,this.videoFrameworkUtils.bind(this.onVideoProgress,this)),this.onAdStart&&e.subscribe(this.videoFrameworkEvents.AD_START,this.videoFrameworkUtils.bind(this.onAdStart,this)),this.onAdComplete&&e.subscribe(this.videoFrameworkEvents.AD_COMPLETE,this.videoFrameworkUtils.bind(this.onAdComplete,this)),this.onEnterFullScreen&&e.subscribe(this.videoFrameworkEvents.FULLSCREEN,this.videoFrameworkUtils.bind(this.onEnterFullScreen,this)),this.onExitFullScreen&&e.subscribe(this.videoFrameworkEvents.EXIT_FULLSCREEN,this.videoFrameworkUtils.bind(this.onExitFullScreen,this)),this.onVideoLoad&&e.subscribe(this.videoFrameworkEvents.VIDEO_LOAD,this.videoFrameworkUtils.bind(this.onVideoLoad,this)),this.onContentLoad&&e.subscribe(this.videoFrameworkEvents.CONTENT_LOAD,this.videoFrameworkUtils.bind(this.onContentLoad,this)),this.onMuted&&e.subscribe(this.videoFrameworkEvents.MUTED,this.videoFrameworkUtils.bind(this.onMuted,this)),this.onUnMuted&&e.subscribe(this.videoFrameworkEvents.UNMUTED,this.videoFrameworkUtils.bind(this.onUnMuted,this)),this.onMediaError&&e.subscribe(this.videoFrameworkEvents.MEDIA_ERROR,this.videoFrameworkUtils.bind(this.onMediaError,this)),this.onAdSkipped&&e.subscribe(this.videoFrameworkEvents.AD_SKIPPED,this.videoFrameworkUtils.bind(this.onAdSkipped,this))},unregisterListeners:function(){this.logger.debug("unregisterListeners");var e=this.player.getSubscription();e.cancel(this.videoFrameworkEvents.TEMPLATE_READY,this.videoFrameworkUtils.bind(this.onTemplateReady,this)),e.cancel(this.videoFrameworkEvents.DESTROY,this.videoFrameworkUtils.bind(this.onDestroy,this)),this.onStreamStart&&e.cancel(this.videoFrameworkEvents.STREAM_START,this.videoFrameworkUtils.bind(this.onStreamStart,this)),this.onVideoStart&&e.cancel(this.videoFrameworkEvents.VIDEO_START,this.videoFrameworkUtils.bind(this.onVideoStart,this)),this.onVideoComplete&&e.cancel(this.videoFrameworkEvents.VIDEO_COMPLETE,this.videoFrameworkUtils.bind(this.onVideoComplete,this)),this.onVideoProgress&&e.cancel(this.videoFrameworkEvents.MEDIA_PROGRESS,this.videoFrameworkUtils.bind(this.onVideoProgress,this)),this.onEnterFullScreen&&e.cancel(this.videoFrameworkEvents.FULLSCREEN,this.videoFrameworkUtils.bind(this.onEnterFullScreen,this)),this.onExitFullScreen&&e.cancel(this.videoFrameworkEvents.EXIT_FULLSCREEN,this.videoFrameworkUtils.bind(this.onExitFullScreen,this)),this.onVideoLoad&&e.cancel(this.videoFrameworkEvents.VIDEO_LOAD,this.videoFrameworkUtils.bind(this.onVideoLoad,this)),this.onContentLoad&&e.cancel(this.videoFrameworkEvents.CONTENT_LOAD,this.videoFrameworkUtils.bind(this.onContentLoad,this)),this.onMuted&&e.cancel(this.videoFrameworkEvents.MUTED,this.videoFrameworkUtils.bind(this.onMuted,this)),this.onUnMuted&&e.cancel(this.videoFrameworkEvents.UNMUTED,this.videoFrameworkUtils.bind(this.onUnMuted,this)),this.onMediaError&&e.cancel(this.videoFrameworkEvents.MEDIA_ERROR,this.videoFrameworkUtils.bind(this.onMediaError,this)),this.onAdSkipped&&e.cancel(this.videoFrameworkEvents.AD_SKIPPED,this.videoFrameworkUtils.bind(this.onAdSkipped,this))},track:function(e){throw new Error("Abstract method error")},getVideoName:function(){var e="";return this.currentVideo&&(e=this.currentVideo.displayName?this.currentVideo.displayName:this.currentVideo.name),e},getVideoId:function(){var e="";return this.currentVideo&&(e=this.currentVideo.referenceId?this.currentVideo.referenceId:this.currentVideo.id),e},getVideoCategory:function(){this.logger.info("getVideoCategory",this.currentVideo);var e="";if(this.currentVideo&&this.currentVideo.tags){var t=this.currentVideo.tags,n=this.currentVideo.tags.length,r="",i="";for(var s=0;s<n;s++){var o=t[s],u=[];/nytsec0_(.+)/.test(o)?(u=/nytsec0_(.+)/.exec(o),u&&u.length>0&&(r=u[1])):/nytsec1_(.+)/.test(o)&&(u=/nytsec1_(.+)/.exec(o),u&&u.length>0&&(i=u[1]))}e=i!==""?i:r}return this.info&&this.info.kicker&&this.info.kicker!==""&&typeof this.info.kicker=="string"&&(e=this.info.kicker),e},getFranchise:function(){this.logger.info("getFranchise",this.currentVideo);var e="";if(this.current